<?php
session_start();
error_reporting(0);
include('includes/config.php');

// Generate CSRF Token and store it in the session if it doesn't exist
if (!isset($_SESSION['csrf_token'])) {
  $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// Validate CSRF token
if (!empty($_POST['csrf_token']) && hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
  $name = $_POST['fullname'];
  $email = $_POST['email'];
  $contactno = $_POST['contactno'];
  $message = $_POST['message'];

  // Server-side validation
  $errors = [];

  if (empty($name)) {
    $errors['name'] = "Name is required";
  } elseif (!preg_match('/^[A-Za-z]+$/', $name)) {
    $errors['name'] = "Name can only contain alphabetic characters";
  }

  if (empty($email)) {
    $errors['email'] = "Email is required";
  } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    $errors['email'] = "Invalid email format";
  }

  if (empty($contactno)) {
    $errors['contactno'] = "Phone number is required";
  } elseif (!preg_match('/^[0-9]+$/', $contactno)) {
    $errors['contactno'] = "Invalid phone number format";
  }

  if (empty($message)) {
    $errors['message'] = "Message is required";
  } elseif (!preg_match('/^[A-Za-z0-9\s.,!?-]+$/', $message)) {
    $errors['message'] = "Message contains invalid characters";
  }

  if (empty($errors)) {
    try {
      // Use prepared statement with parameter binding to prevent SQL injection
      $sql = "INSERT INTO tblcontactusquery (name, EmailId, ContactNumber, Message) VALUES (:name, :email, :contactno, :message)";
      $query = $dbh->prepare($sql);
      $query->bindParam(':name', $name, PDO::PARAM_STR);
      $query->bindParam(':email', $email, PDO::PARAM_STR);
      $query->bindParam(':contactno', $contactno, PDO::PARAM_STR);
      $query->bindParam(':message', $message, PDO::PARAM_STR);

      if ($query->execute()) {
        $msg = "Query Sent. We will contact you shortly";
      } else {
        $error = "Something went wrong. Please try again";
      }
    } catch (PDOException $e) {
      // Handle any exceptions or errors
      $error = "Database error: " . $e->getMessage();
    }
  }
}

// Add X-Frame-Options header to prevent Clickjacking
header("X-Frame-Options: DENY");

?>




<!DOCTYPE HTML>
<html lang="en">

<head>

  <title>Car Rental|| Contact Us Page</title>
  <!--Bootstrap -->
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" type="text/css">
  <!--Custome Style -->
  <link rel="stylesheet" href="assets/css/style.css" type="text/css">
  <!--OWL Carousel slider-->
  <link rel="stylesheet" href="assets/css/owl.carousel.css" type="text/css">
  <link rel="stylesheet" href="assets/css/owl.transitions.css" type="text/css">
  <!--slick-slider -->
  <link href="assets/css/slick.css" rel="stylesheet">
  <!--bootstrap-slider -->
  <link href="assets/css/bootstrap-slider.min.css" rel="stylesheet">
  <!--FontAwesome Font Style -->
  <link href="assets/css/font-awesome.min.css" rel="stylesheet">

  <!-- SWITCHER -->
  <link rel="stylesheet" id="switcher-css" type="text/css" href="assets/switcher/css/switcher.css" media="all" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/red.css" title="red" media="all" data-default-color="true" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/orange.css" title="orange" media="all" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/blue.css" title="blue" media="all" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/pink.css" title="pink" media="all" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/green.css" title="green" media="all" />
  <link rel="alternate stylesheet" type="text/css" href="assets/switcher/css/purple.css" title="purple" media="all" />

  <!-- Fav and touch icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/images/favicon-icon/apple-touch-icon-144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/images/favicon-icon/apple-touch-icon-114-precomposed.html">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/images/favicon-icon/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="assets/images/favicon-icon/apple-touch-icon-57-precomposed.png">
  <link rel="shortcut icon" href="assets/images/favicon-icon/favicon.png">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900" rel="stylesheet">
  <style>
    .errorWrap {
      padding: 10px;
      margin: 0 0 20px 0;
      background: #fff;
      border-left: 4px solid #dd3d36;
      -webkit-box-shadow: 0 1px 1px 0 rgba(0, 0, 0, .1);
      box-shadow: 0 1px 1px 0 rgba(0, 0, 0, .1);
    }

    .succWrap {
      padding: 10px;
      margin: 0 0 20px 0;
      background: #fff;
      border-left: 4px solid #5cb85c;
      -webkit-box-shadow: 0 1px 1px 0 rgba(0, 0, 0, .1);
      box-shadow: 0 1px 1px 0 rgba(0, 0, 0, .1);
    }
  </style>
</head>

<body>

  <<!-- Start Switcher -->
    <?php include('includes/colorswitcher.php'); ?>
    <!-- /Switcher -->

    <!--Header-->
    <?php include('includes/header.php'); ?>
    <!-- /Header -->

    <!--Page Header-->
    <section class="page-header contactus_page">
      <div class="container">
        <div class="page-header_wrap">
          <div class="page-heading">
            <h1>Contact Us</h1>
          </div>
          <ul class="coustom-breadcrumb">
            <li><a href="#">Home</a></li>
            <li>Contact Us</li>
          </ul>
        </div>
      </div>
      <!-- Dark Overlay-->
      <div class="dark-overlay"></div>
    </section>
    <!-- /Page Header-->

    <!-- Contact-us -->
    <section class="contact_us section-padding">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h3>Get in touch using the form below</h3>
            <?php if (!empty($errors)): ?>
              <div class="errorWrap">
                <strong>ERROR:</strong> Please fix the following errors:
                <ul>
                  <?php foreach ($errors as $error): ?>
                    <li><?php echo htmlentities($error); ?></li>
                  <?php endforeach; ?>
                </ul>
              </div>
            <?php elseif (isset($msg)): ?>
              <div class="succWrap"><strong>SUCCESS:</strong><?php echo htmlentities($msg); ?></div>
            <?php endif; ?>
            <div class="contact_form gray-bg">
              <form method="post" onsubmit="return validateForm();">
                <div class="form-group">
                  <label class="control-label">Full Name <span>*</span></label>
                  <input type="text" name="fullname" class="form-control white_bg" id="fullname" required>
                </div>
                <div class="form-group">
                  <label class="control-label">Email Address <span>*</span></label>
                  <input type="email" name="email" class="form-control white_bg" id="emailaddress" required>
                </div>
                <div class="form-group">
                  <label class="control-label">Phone Number <span>*</span></label>
                  <input type="text" name="contactno" class="form-control white_bg" id="phonenumber" required maxlength="10" pattern="[0-9]+">
                </div>
                <div class="form-group">
                  <label class="control-label">Message <span>*</span></label>
                  <textarea class="form-control white_bg" name="message" rows="4" required></textarea>
                </div>
                <!-- CSRF Token (hidden input field) -->
                <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
                <div class="form-group">
                  <button class="btn" type="submit" name="send">Send Message <span class="angle_arrow"><i class="fa fa-angle-right" aria-hidden="true"></i></span></button>
                </div>
              </form>
            </div>
          </div>
          <!-- Include your contact info section here -->
          <div class="col-md-6">
            <h3>Contact Info</h3>
            <div class="contact_detail">
              <?php
              $pagetype = $_GET['type'];
              $sql = "SELECT Address,EmailId,ContactNo from tblcontactusinfo";
              $query = $dbh->prepare($sql);
              $query->execute();
              $results = $query->fetchAll(PDO::FETCH_OBJ);
              $cnt = 1;
              if ($query->rowCount() > 0) {
                foreach ($results as $result) { ?>
                  <ul>
                    <li>
                      <div class="icon_wrap"><i class="fa fa-map-marker" aria-hidden="true"></i></div>
                      <div class="contact_info_m"><?php echo htmlentities($result->Address); ?></div>
                    </li>
                    <li>
                      <div class="icon_wrap"><i class="fa fa-phone" aria-hidden="true"></i></div>
                      <div class="contact_info_m"><a href="tel:61-1234-567-90"><?php echo htmlentities($result->EmailId); ?></a></div>
                    </li>
                    <li>
                      <div class="icon_wrap"><i class="fa fa-envelope-o" aria-hidden="true"></i></div>
                      <div class="contact_info_m"><a href="mailto:contact@exampleurl.com"><?php echo htmlentities($result->ContactNo); ?></a></div>
                    </li>
                  </ul>
              <?php }
              } ?>
            </div>
          </div>

        </div>
      </div>
    </section>
    <!-- /Contact-us-->
    <!--Footer -->
    <?php include('includes/footer.php'); ?>
    <!-- /Footer-->

    <!--Back to top-->
    <div id="back-top" class="back-top"> <a href="#top"><i class="fa fa-angle-up" aria-hidden="true"></i> </a> </div>
    <!--/Back to top-->

    <!--Login-Form -->
    <?php include('includes/login.php'); ?>
    <!--/Login-Form -->

    <!--Register-Form -->
    <?php include('includes/registration.php'); ?>

    <!--/Register-Form -->

    <!--Forgot-password-Form -->
    <?php include('includes/forgotpassword.php'); ?>
    <!--/Forgot-password-Form -->

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/interface.js"></script>
    <!--Switcher-->
    <script src="assets/switcher/js/switcher.js"></script>
    <!--bootstrap-slider-JS-->
    <script src="assets/js/bootstrap-slider.min.js"></script>
    <!--Slider-JS-->
    <script src="assets/js/slick.min.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>

</body>

<!-- Mirrored from themes.webmasterdriver.net/carforyou/demo/contact-us.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 16 Jun 2017 07:26:55 GMT -->

</html>